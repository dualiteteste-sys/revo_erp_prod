name: LGPD retention (PROD)

on:
  schedule:
    # 03:10 UTC diariamente (ajuste conforme necessidade).
    - cron: "10 3 * * *"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Simular (nÃ£o apagar)"
        type: boolean
        required: false
        default: false

permissions:
  contents: read
  issues: write

concurrency:
  group: lgpd-retention-prod
  cancel-in-progress: false

jobs:
  retention:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Install psql + jq
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client jq

      - name: Run retention function on PROD
        id: run
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DB_URL_PROD }}
          DRY_RUN_INPUT: ${{ inputs.dry_run }}
        run: |
          set -euo pipefail

          if [[ -z "${DATABASE_URL:-}" ]]; then
            echo "Missing secret SUPABASE_DB_URL_PROD" >&2
            exit 1
          fi

          DRY_RUN="false"
          if [[ "${DRY_RUN_INPUT:-}" == "true" ]]; then DRY_RUN="true"; fi

          OUT="$(psql "$DATABASE_URL" -Atc "select public.lgpd_run_retention(${DRY_RUN})::text;")"
          echo "out=$OUT" >> "$GITHUB_OUTPUT"

          ok="$(echo "$OUT" | jq -r '.ok // false')"
          echo "ok=$ok" >> "$GITHUB_OUTPUT"

      - name: Upsert retention alert issue (when ok=false)
        if: steps.run.outputs.ok != 'true'
        uses: actions/github-script@v7
        env:
          OUT: ${{ steps.run.outputs.out }}
        with:
          script: |
            const title = "LGPD RETENTION ALERT (PROD): falha ao executar expurgo";
            const labels = ["lgpd", "ops-alert"];
            const body = [
              "Falha ao executar `public.lgpd_run_retention` em PROD.",
              "",
              "Resposta (JSON):",
              "```json",
              String(process.env.OUT ?? "{}"),
              "```",
              "",
              `Run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
            ].join("\n");

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              labels: labels.join(","),
              per_page: 100,
            });
            const existing = issues.find(i => i.title === title);
            if (existing) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body,
              });
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels,
            });

