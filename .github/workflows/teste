name: supabase-migrations-main

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  verify-baseline:
    name: Apply BASELINE to VERIFY (idempotent)
    runs-on: ubuntu-latest
    env:
      SUPABASE_DB_URL_VERIFY: ${{ secrets.SUPABASE_DB_URL_VERIFY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      # ⬇️ Stubs para funções de contexto referenciadas como DEFAULT na baseline
      - name: [VERIFY] Pré-criar stubs de funções de contexto
        run: |
          set -euo pipefail
          echo "[VERIFY][STUBS] Criando stubs para funções de contexto…"
          psql "$SUPABASE_DB_URL_VERIFY" -v ON_ERROR_STOP=1 <<'SQL'
          SET search_path = pg_catalog, public;

          -- Stub: current_empresa_id() — usado em DEFAULT de colunas
          CREATE OR REPLACE FUNCTION public.current_empresa_id()
          RETURNS uuid
          LANGUAGE sql
          STABLE
          SET search_path = pg_catalog, public
          AS $$
            SELECT NULL::uuid
          $$;

          -- Stub: current_user_id() — algumas tabelas também usam em DEFAULT
          CREATE OR REPLACE FUNCTION public.current_user_id()
          RETURNS uuid
          LANGUAGE sql
          STABLE
          SET search_path = pg_catalog, public
          AS $$
            SELECT NULL::uuid
          $$;
          SQL
          echo "[VERIFY][STUBS] OK"

      # ⬇️ Aplica a baseline gerada pelo db diff
      - name: [VERIFY] Apply BASELINE via psql
        run: |
          set -euo pipefail
          echo "[MIGRATE][VERIFY] Procurando baseline em supabase/migrations…"
          BASELINE="$(ls -1 supabase/migrations/*_baseline.sql | head -n 1)"
          if [ -z "$BASELINE" ]; then
            echo "[MIGRATE][VERIFY] Nenhum arquivo *_baseline.sql encontrado."
            exit 1
          fi
          echo "[MIGRATE][VERIFY] BASELINE => $BASELINE"
          echo "[MIGRATE][VERIFY] Aplicando baseline via psql (ON_ERROR_STOP=1)…"
          psql "$SUPABASE_DB_URL_VERIFY" -v ON_ERROR_STOP=1 -f "$BASELINE"

  migrate-prod:
    name: Apply migrations to PROD (após baseline no VERIFY)
    runs-on: ubuntu-latest
    needs: verify-baseline
    environment:
      name: production
    env:
      SUPABASE_DB_URL_PROD: ${{ secrets.SUPABASE_DB_URL_PROD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Apply migrations to PROD (supabase db push)
        run: |
          set -euo pipefail
          echo "[MIGRATE][PROD] Aplicando migrations com supabase db push…"
          supabase db push --db-url "$SUPABASE_DB_URL_PROD"
          echo "[MIGRATE][PROD] Concluído."
