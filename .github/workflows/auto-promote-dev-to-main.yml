name: Auto-promote dev → main

# After dev CI passes on a push to dev, automatically create/update
# a dev→main PR and enable auto-merge.
# This eliminates manual PR creation for routine promotions.

on:
  workflow_run:
    workflows: ["Release Gate (dev) — unit + e2e + migrations"]
    branches: [dev]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-promote-dev-main
  cancel-in-progress: true

jobs:
  promote:
    name: Promote dev → main
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'push')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0

      - name: Check if dev is ahead of main
        id: diff
        run: |
          set -euo pipefail
          git fetch origin main
          ahead=$(git rev-list --count origin/main..origin/dev)
          echo "ahead=$ahead" >> "$GITHUB_OUTPUT"
          if [[ "$ahead" == "0" ]]; then
            echo "::notice::dev is in sync with main — nothing to promote."
          else
            echo "::notice::dev is $ahead commit(s) ahead of main."
          fi

      - name: Find or create PR
        if: steps.diff.outputs.ahead != '0'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          existing=$(gh pr list --base main --head dev --state open --json number --jq '.[0].number // empty' 2>/dev/null || echo "")

          if [[ -n "$existing" ]]; then
            echo "::notice::Using existing PR #${existing}"
            echo "number=$existing" >> "$GITHUB_OUTPUT"
          else
            echo "::notice::Creating new dev → main PR..."
            pr_url=$(gh pr create \
              --base main \
              --head dev \
              --title "chore: promote dev → main" \
              --body "$(cat <<'BODY'
## Auto-promote

Automated PR created after dev CI passed.

Changes validated by:
- Release Gate (dev) — unit + e2e + migrations
- E2E Release Gate (dev) — sharded

Generated by auto-promote workflow
BODY
)")
            pr_number=$(echo "$pr_url" | grep -o '[0-9]*$')
            echo "number=$pr_number" >> "$GITHUB_OUTPUT"
          fi

      - name: Enable auto-merge
        if: steps.diff.outputs.ahead != '0' && steps.pr.outputs.number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          pr="${{ steps.pr.outputs.number }}"
          echo "Enabling auto-merge on PR #${pr}..."
          gh pr merge "$pr" --auto --merge || echo "::warning::Could not enable auto-merge. Check branch protection rules."
