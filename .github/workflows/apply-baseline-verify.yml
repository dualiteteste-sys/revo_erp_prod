name: apply-baseline-verify

on:
  workflow_dispatch:

jobs:
  apply-baseline-to-verify:
    name: Apply BASELINE to VERIFY (patched ENUMs)
    runs-on: ubuntu-latest

    env:
      SUPABASE_DB_URL_VERIFY: ${{ secrets.SUPABASE_DB_URL_VERIFY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client

      - name: Patch baseline (remove CREATE TYPE dos 3 ENUMs)
        id: patch
        shell: bash
        run: |
          set -euo pipefail

          # Localiza o primeiro baseline no diretório
          BASELINE="$(ls -1 supabase/migrations/*_baseline.sql | head -n 1)"
          if [[ -z "${BASELINE:-}" || ! -f "$BASELINE" ]]; then
            echo "Baseline não encontrado em supabase/migrations/*_baseline.sql"
            exit 1
          fi

          OUT="${BASELINE%.sql}.patched.sql"
          cp "$BASELINE" "$OUT"

          # Função: remove bloco CREATE TYPE ... AS ENUM (...) até a linha que fecha com ');
          strip_enum () {
            local ENUM_NAME="$1"
            local TMP="${OUT}.tmp"

            # Explicação:
            #  - Match simples por 'CREATE TYPE (public.)?ENUM_NAME AS ENUM (' (ignorando espaços)
            #  - Entra em 'inblk=1' e ignora até encontrar linha com ');'
            #  - Evita classes [:<:] [:>:] que quebram em alguns awk
            awk -v ENUM_NAME="$ENUM_NAME" '
              BEGIN { inblk=0 }
              {
                line=$0
                # normaliza múltiplos espaços para comparação (somente para detecção)
                norm=line
                gsub(/\t/," ",norm)
                gsub(/  +/," ",norm)
              }
              inblk == 0 && norm ~ /^[[:space:]]*CREATE TYPE[[:space:]]+(public\.)?/ && norm ~ (" " ENUM_NAME " ") && norm ~ / AS ENUM[[:space:]]*\(/ {
                inblk=1
                next
              }
              inblk == 1 {
                if ($0 ~ /\)\s*;\s*$/) { inblk=0 }
                next
              }
              { print }
            ' "$OUT" > "$TMP"

            mv "$TMP" "$OUT"
          }

          # Remove os 3 enums problemáticos (idempotente; se não existir, nada é removido)
          for e in meta_tipo billing_cycle contribuinte_icms_enum; do
            echo "[PATCH] Removendo bloco CREATE TYPE: $e"
            strip_enum "$e"
          done

          echo "baseline_patched=$OUT" >> "$GITHUB_OUTPUT"

      - name: Apply PATCHED BASELINE
        shell: bash
        run: |
          set -euo pipefail
          FILE="${{ steps.patch.outputs.baseline_patched }}"
          if [[ -z "${FILE:-}" || ! -f "$FILE" ]]; then
            echo "Arquivo patchado não encontrado."
            exit 1
          fi
          # Aplica com falha imediata em qualquer erro
          psql "$SUPABASE_DB_URL_VERIFY" -v ON_ERROR_STOP=1 -f "$FILE"
