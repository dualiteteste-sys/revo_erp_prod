name: apply-baseline-to-verify
on:
  workflow_dispatch:

jobs:
  baseline-verify:
    name: Apply BASELINE to VERIFY (patched)
    runs-on: ubuntu-latest
    env:
      SUPABASE_DB_URL_VERIFY: ${{ secrets.SUPABASE_DB_URL_VERIFY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Locate baseline
        id: locate
        run: |
          set -euo pipefail
          BASELINE="$(ls -1 supabase/migrations/*_baseline.sql | head -n 1 || true)"
          if [ -z "${BASELINE:-}" ]; then
            echo "Nenhum *_baseline.sql em supabase/migrations"; exit 1
          fi
          echo "BASELINE=$BASELINE" >> "$GITHUB_ENV"
          echo "Baseline: $BASELINE"

      - name: Prelude (cria schema audit e ENUMs se faltarem)
        run: |
          set -euo pipefail
          psql "$SUPABASE_DB_URL_VERIFY" -v ON_ERROR_STOP=1 <<'SQL'
          -- schema audit
          DO $$
          BEGIN
            IF NOT EXISTS (SELECT 1 FROM pg_namespace WHERE nspname='audit') THEN
              EXECUTE 'CREATE SCHEMA audit';
            END IF;
          END $$;

          -- ENUM: meta_tipo
          DO $$
          BEGIN
            IF NOT EXISTS (
              SELECT 1
              FROM pg_type t JOIN pg_namespace n ON n.oid = t.typnamespace
              WHERE t.typtype='e' AND t.typname='meta_tipo' AND n.nspname='public'
            ) THEN
              EXECUTE 'CREATE TYPE public.meta_tipo AS ENUM (''mensal'',''trimestral'',''anual'')';
            END IF;
          END $$;

          -- ENUM: billing_cycle
          DO $$
          BEGIN
            IF NOT EXISTS (
              SELECT 1
              FROM pg_type t JOIN pg_namespace n ON n.oid = t.typnamespace
              WHERE t.typtype='e' AND t.typname='billing_cycle' AND n.nspname='public'
            ) THEN
              EXECUTE 'CREATE TYPE public.billing_cycle AS ENUM (''monthly'',''yearly'')';
            END IF;
          END $$;

          -- ENUM: contribuinte_icms_enum
          DO $$
          BEGIN
            IF NOT EXISTS (
              SELECT 1
              FROM pg_type t JOIN pg_namespace n ON n.oid = t.typnamespace
              WHERE t.typtype='e' AND t.typname='contribuinte_icms_enum' AND n.nspname='public'
            ) THEN
              EXECUTE 'CREATE TYPE public.contribuinte_icms_enum AS ENUM (''contribuinte'',''nao_contribuinte'')';
            END IF;
          END $$;
          SQL

      - name: Patch baseline (remover quaisquer CREATE TYPE dos 3 ENUMs)
        run: |
          set -euo pipefail
          IN="$BASELINE"
          OUT="${IN%.sql}.patched.sql"
          cp "$IN" "$OUT"

          # Stripper robusto: ignora CREATE TYPE (com ou sem aspas/schema) até a linha de fechamento );
          strip_enum () {
            local ENUM="$1"
            awk -v IGNORECASE=1 -v ENUM="$ENUM" '
              BEGIN { inblk=0 }
              {
                if (inblk) {
                  if ($0 ~ /\)\s*;\s*$/) { inblk=0 }
                  next
                }
                # MATCH exemplos:
                # CREATE TYPE billing_cycle AS ENUM (
                # CREATE TYPE "billing_cycle" AS ENUM (
                # CREATE TYPE public.billing_cycle AS ENUM (
                # CREATE TYPE "public"."billing_cycle" AS ENUM (
                if ($0 ~ /^[[:space:]]*CREATE[[:space:]]+TYPE[[:space:]]+.*([."[:space:]]|^) *"?ENUM"?"? *$/) { } # só pra não dar erro de sintaxe no awk antigo
                if ($0 ~ /^[[:space:]]*CREATE[[:space:]]+TYPE[[:space:]]+/) {
                  # procura o nome do enum na linha
                  if ($0 ~ ("[[:<:]]" ENUM "[[:>:]]")) {
                    # e exige AS ENUM na mesma linha
                    if ($0 ~ /AS[[:space:]]+ENUM[[:space:]]*\(/) { inblk=1; next }
                  }
                }
                print
              }
            ' "$OUT" > "${OUT}.tmp" && mv "${OUT}.tmp" "$OUT"
          }

          for e in meta_tipo billing_cycle contribuinte_icms_enum; do
            echo "[PATCH] Removendo bloco CREATE TYPE: $e"
            strip_enum "$e"
          done

          echo "PATCHED_BASELINE=$OUT" >> "$GITHUB_ENV"
          echo "Arquivo patchado em: $OUT"
          sed -n '1,40p' "$OUT" || true

      - name: Apply PATCHED BASELINE
        run: |
          set -euo pipefail
          psql "$SUPABASE_DB_URL_VERIFY" -v ON_ERROR_STOP=1 -f "$PATCHED_BASELINE"
          echo "[VERIFY] Baseline aplicada com sucesso."
