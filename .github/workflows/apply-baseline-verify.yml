name: apply-baseline-to-verify
on:
  workflow_dispatch:

jobs:
  baseline-verify:
    name: Apply BASELINE to VERIFY (patched)
    runs-on: ubuntu-latest
    env:
      SUPABASE_DB_URL_VERIFY: ${{ secrets.SUPABASE_DB_URL_VERIFY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PostgreSQL client (psql)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Locate baseline file
        id: locate
        run: |
          set -euo pipefail
          BASELINE="$(ls -1 supabase/migrations/*_baseline.sql | head -n 1 || true)"
          if [ -z "${BASELINE:-}" ]; then
            echo "Nenhum *_baseline.sql encontrado em supabase/migrations"; exit 1
          fi
          echo "BASELINE=$BASELINE" | tee -a "$GITHUB_ENV"
          echo "Baseline localizado: $BASELINE"

      - name: Prelude on VERIFY (schema audit + ENUMs condicionalmente)
        run: |
          set -euo pipefail
          psql "$SUPABASE_DB_URL_VERIFY" -v ON_ERROR_STOP=1 <<'SQL'
          -- 1) schema audit
          DO $$
          BEGIN
            IF NOT EXISTS (SELECT 1 FROM pg_namespace WHERE nspname='audit') THEN
              EXECUTE 'CREATE SCHEMA audit';
            END IF;
          END $$;

          -- 2) ENUMs que o baseline tenta criar. Cria APENAS se não existirem.
          DO $$ BEGIN
            IF NOT EXISTS (
              SELECT 1 FROM pg_type t
              JOIN pg_namespace n ON n.oid = t.typnamespace
              WHERE t.typtype='e' AND t.typname='meta_tipo' AND n.nspname='public'
            ) THEN
              -- Ajuste os valores conforme seu baseline, se necessário
              EXECUTE 'CREATE TYPE public.meta_tipo AS ENUM (''mensal'', ''trimestral'', ''anual'')';
            END IF;
          END $$;

          DO $$ BEGIN
            IF NOT EXISTS (
              SELECT 1 FROM pg_type t
              JOIN pg_namespace n ON n.oid = t.typnamespace
              WHERE t.typtype='e' AND t.typname='billing_cycle' AND n.nspname='public'
            ) THEN
              EXECUTE 'CREATE TYPE public.billing_cycle AS ENUM (''monthly'', ''yearly'')';
            END IF;
          END $$;

          DO $$ BEGIN
            IF NOT EXISTS (
              SELECT 1 FROM pg_type t
              JOIN pg_namespace n ON n.oid = t.typnamespace
              WHERE t.typtype='e' AND t.typname='contribuinte_icms_enum' AND n.nspname='public'
            ) THEN
              EXECUTE 'CREATE TYPE public.contribuinte_icms_enum AS ENUM (''contribuinte'', ''nao_contribuinte'')';
            END IF;
          END $$;
          SQL

      - name: Build PATCHED copy of baseline (remove CREATE TYPE blocks que já existem)
        run: |
          set -euo pipefail
          IN="$BASELINE"
          OUT="${IN%.sql}.patched.sql"
          cp "$IN" "$OUT"

          strip_enum () {
            local ENUM="$1"
            # Remove o bloco "CREATE TYPE <enum> AS ENUM ( ... );"
            awk -v ENUM="$ENUM" '
              BEGIN { inblk=0 }
              # início do bloco CREATE TYPE <enum> AS ENUM (
              $0 ~ "^[[:space:]]*CREATE[[:space:]]+TYPE[[:space:]]+"ENUM"[[:space:]]+AS[[:space:]]+ENUM[[:space:]]*\\(" {
                inblk=1; next
              }
              # dentro do bloco (até fechar com ");")
              inblk && /\)\s*;\s*$/ { inblk=0; next }
              inblk { next }
              { print }
            ' "$OUT" > "${OUT}.tmp" && mv "${OUT}.tmp" "$OUT"
          }

          # Liste todos os ENUMs que o baseline cria
          ENUMS=(meta_tipo billing_cycle contribuinte_icms_enum)

          for e in "${ENUMS[@]}"; do
            echo "[PATCH] Removendo bloco CREATE TYPE para: $e"
            strip_enum "$e"
          done

          echo "PATCHED_BASELINE=$OUT" >> "$GITHUB_ENV"
          echo "Arquivo patchado: $OUT"
          echo "Primeiras linhas do patch:"
          head -n 40 "$OUT" || true

      - name: Apply PATCHED BASELINE to VERIFY
        run: |
          set -euo pipefail
          FILE="${PATCHED_BASELINE:-$BASELINE}"
          echo "[MIGRATE][VERIFY] Aplicando $FILE"
          psql "$SUPABASE_DB_URL_VERIFY" -v ON_ERROR_STOP=1 -f "$FILE"
          echo "[MIGRATE][VERIFY] Baseline aplicada com sucesso."
