name: apply-baseline-to-verify
on:
  workflow_dispatch:

jobs:
  baseline-verify:
    name: Apply BASELINE to VERIFY (patched)
    runs-on: ubuntu-latest
    env:
      SUPABASE_DB_URL_VERIFY: ${{ secrets.SUPABASE_DB_URL_VERIFY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Locate baseline
        id: locate
        run: |
          set -euo pipefail
          BASELINE="$(ls -1 supabase/migrations/*_baseline.sql | head -n 1 || true)"
          if [ -z "${BASELINE:-}" ]; then
            echo "Nenhum *_baseline.sql em supabase/migrations"; exit 1
          fi
          echo "BASELINE=$BASELINE" >> "$GITHUB_ENV"
          echo "Baseline: $BASELINE"

      - name: Prelude (audit + ENUMs se faltarem)
        run: |
          set -euo pipefail
          psql "$SUPABASE_DB_URL_VERIFY" -v ON_ERROR_STOP=1 <<'SQL'
          -- schema audit
          DO $$
          BEGIN
            IF NOT EXISTS (SELECT 1 FROM pg_namespace WHERE nspname='audit') THEN
              EXECUTE 'CREATE SCHEMA audit';
            END IF;
          END $$;

          -- ENUM: meta_tipo
          DO $$
          BEGIN
            IF NOT EXISTS (
              SELECT 1
              FROM pg_type t
              JOIN pg_namespace n ON n.oid = t.typnamespace
              WHERE t.typtype='e' AND t.typname='meta_tipo' AND n.nspname='public'
            ) THEN
              EXECUTE 'CREATE TYPE public.meta_tipo AS ENUM (''mensal'',''trimestral'',''anual'')';
            END IF;
          END $$;

          -- ENUM: billing_cycle
          DO $$
          BEGIN
            IF NOT EXISTS (
              SELECT 1
              FROM pg_type t
              JOIN pg_namespace n ON n.oid = t.typnamespace
              WHERE t.typtype='e' AND t.typname='billing_cycle' AND n.nspname='public'
            ) THEN
              EXECUTE 'CREATE TYPE public.billing_cycle AS ENUM (''monthly'',''yearly'')';
            END IF;
          END $$;

          -- ENUM: contribuinte_icms_enum
          DO $$
          BEGIN
            IF NOT EXISTS (
              SELECT 1
              FROM pg_type t
              JOIN pg_namespace n ON n.oid = t.typnamespace
              WHERE t.typtype='e' AND t.typname='contribuinte_icms_enum' AND n.nspname='public'
            ) THEN
              EXECUTE 'CREATE TYPE public.contribuinte_icms_enum AS ENUM (''contribuinte'',''nao_contribuinte'')';
            END IF;
          END $$;
          SQL

      - name: Patch baseline (remover CREATE TYPE)
        run: |
          set -euo pipefail
          IN="$BASELINE"
          OUT="${IN%.sql}.patched.sql"
          cp "$IN" "$OUT"

          strip_enum () {
            local ENUM="$1"
            awk -v ENUM="$ENUM" '
              BEGIN { inblk=0 }
              $0 ~ "^[[:space:]]*CREATE[[:space:]]+TYPE[[:space:]]+(public\\.)?"ENUM"[[:space:]]+AS[[:space:]]+ENUM[[:space:]]*\\(" { inblk=1; next }
              inblk && /\)\s*;\s*$/ { inblk=0; next }
              inblk { next }
              { print }
            ' "$OUT" > "${OUT}.tmp" && mv "${OUT}.tmp" "$OUT"
          }

          for e in meta_tipo billing_cycle contribuinte_icms_enum; do
            echo "[PATCH] Removendo CREATE TYPE de: $e"
            strip_enum "$e"
          done

          echo "PATCHED_BASELINE=$OUT" >> "$GITHUB_ENV"
          echo "Arquivo patchado: $OUT"
          head -n 40 "$OUT" || true

      - name: Apply PATCHED BASELINE
        run: |
          set -euo pipefail
          psql "$SUPABASE_DB_URL_VERIFY" -v ON_ERROR_STOP=1 -f "$PATCHED_BASELINE"
          echo "[VERIFY] Baseline aplicada com sucesso."
