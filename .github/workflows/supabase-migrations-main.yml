name: supabase-migrations-main

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  apply-baseline-verify:
    name: Apply BASELINE to VERIFY via psql
    runs-on: ubuntu-latest
    env:
      SUPABASE_DB_URL_VERIFY: ${{ secrets.SUPABASE_DB_URL_VERIFY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Apply BASELINE to VERIFY via psql
        shell: bash
        run: |
          set -euo pipefail
          echo "[MIGRATE][VERIFY] Procurando baseline em supabase/migrations..."
          BASELINE="$(ls -1 supabase/migrations/*_baseline.sql | tail -n 1)"
          if [ -z "$BASELINE" ]; then
            echo "[MIGRATE][VERIFY] Nenhum arquivo *_baseline.sql encontrado."
            exit 1
          fi
          echo "[MIGRATE][VERIFY] BASELINE => ${BASELINE}"
          psql "$SUPABASE_DB_URL_VERIFY" -v ON_ERROR_STOP=1 -f "$BASELINE"
          echo "[MIGRATE][VERIFY] Baseline aplicada no VERIFY."

  migrate-sync-history:
    name: Sync migration history (VERIFY → PROD)
    runs-on: ubuntu-latest
    needs: apply-baseline-verify
    environment:
      name: production
    env:
      SUPABASE_DB_URL_VERIFY: ${{ secrets.SUPABASE_DB_URL_VERIFY }}
      SUPABASE_DB_URL_PROD:   ${{ secrets.SUPABASE_DB_URL_PROD }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: supabase db push (VERIFY)
        run: |
          set -euo pipefail
          echo "[MIGRATE][VERIFY] Rodando supabase db push no VERIFY para alinhar histórico..."
          supabase db push --db-url "$SUPABASE_DB_URL_VERIFY"
          echo "[MIGRATE][VERIFY] Histórico sincronizado."

      - name: supabase db push (PROD)
        run: |
          set -euo pipefail
          echo "[MIGRATE][PROD] Rodando supabase db push no PROD para alinhar histórico..."
          supabase db push --db-url "$SUPABASE_DB_URL_PROD"
          echo "[MIGRATE][PROD] Histórico sincronizado."
