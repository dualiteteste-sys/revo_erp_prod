name: supabase-migrations-main

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  migrate-verify:
    name: Apply BASELINE to DR VERIFY (psql only)
    runs-on: ubuntu-latest

    env:
      # URL do banco VERIFY (revo-dr-verify)
      SUPABASE_DB_URL_VERIFY: ${{ secrets.SUPABASE_DB_URL_VERIFY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PostgreSQL client (psql)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Reset PUBLIC schema in VERIFY (destrutivo)
        run: |
          set -euo pipefail
          echo "[VERIFY][RESET] Drop + create do schema public..."
          psql "$SUPABASE_DB_URL_VERIFY" -v ON_ERROR_STOP=1 <<'SQL'
          DO $$
          BEGIN
            IF EXISTS (SELECT 1 FROM pg_namespace WHERE nspname = 'public') THEN
              EXECUTE 'DROP SCHEMA public CASCADE';
            END IF;
            EXECUTE 'CREATE SCHEMA public';
          END $$;
          SQL
          echo "[VERIFY][RESET] public recriado. Prosseguir com a baseline no próximo step."
    

      - name: Apply BASELINE to VERIFY via psql
        run: |
          set -euo pipefail

          echo "[MIGRATE][VERIFY] Procurando baseline em supabase/migrations..."

          # Evita 'Broken pipe': usar glob em array em vez de 'find | head'
          shopt -s nullglob
          files_baseline=(supabase/migrations/*baseline*.sql)
          files_all=(supabase/migrations/*.sql)

          if [ ${#files_baseline[@]} -gt 0 ]; then
            BASELINE_FILE="${files_baseline[0]}"
          elif [ ${#files_all[@]} -gt 0 ]; then
            BASELINE_FILE="${files_all[0]}"
          else
            echo "::error::Baseline .sql não encontrado em supabase/migrations"
            exit 1
          fi

          echo "[MIGRATE][VERIFY] BASELINE => $BASELINE_FILE"
          echo "[MIGRATE][VERIFY] Aplicando baseline via psql (ON_ERROR_STOP=1)..."
          psql "$SUPABASE_DB_URL_VERIFY" -v ON_ERROR_STOP=1 -f "$BASELINE_FILE"
          echo "[MIGRATE][VERIFY] Baseline aplicada com sucesso em VERIFY."


  migrate-prod:
    name: Apply migrations to PROD (sistema revo estável)
    runs-on: ubuntu-latest
    needs: migrate-verify
    environment:
      name: production

    env:
      SUPABASE_DB_URL_PROD: ${{ secrets.SUPABASE_DB_URL_PROD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Supabase CLI (for future incremental pushes)
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Sanity check on PROD (no schema changes yet)
        run: |
          set -euo pipefail
          echo "[MIGRATE][PROD] Nenhuma alteração de schema aplicada agora."
          echo "[MIGRATE][PROD] Estratégia atual: baseline já consolidada; aguardar 'migration repair' e novas migrations incrementais."
          # Se quiser apenas validar conectividade:
          psql "$SUPABASE_DB_URL_PROD" -c "select current_timestamp as connected_at;"
          echo "[MIGRATE][PROD] OK."

      # ────────────────────────────────────────────────────────────────────────────
      # QUANDO habilitarmos migrations incrementais após 'supabase migration repair',
      # troque o step acima por um 'db push' (ou adicione um novo step condicional):
      #
      # - name: Apply new migrations to PROD (incremental)
      #   if: ${{ always() }}
      #   run: |
      #     set -euo pipefail
      #     supabase db push --db-url "$SUPABASE_DB_URL_PROD"
      #     echo "[MIGRATE][PROD] Migrations aplicadas com sucesso."
      # ────────────────────────────────────────────────────────────────────────────
