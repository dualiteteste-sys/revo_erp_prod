name: Compare DEV vs PROD schema (public)

on:
  workflow_dispatch:
  schedule:
    # Diário 07:00 UTC (04:00 Brasil) — ajuste se preferir
    - cron: "0 7 * * *"

permissions:
  contents: read
  issues: write

jobs:
  compare:
    name: Compare public schema (DEV ↔ PROD)
    runs-on: ubuntu-latest

    env:
      SUPABASE_DB_URL_DEV: ${{ secrets.SUPABASE_DB_URL_DEV }}
      SUPABASE_DB_URL_PROD: ${{ secrets.SUPABASE_DB_URL_PROD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PostgreSQL client (psql)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Validate secrets
        run: |
          set -euo pipefail
          if [[ -z "${SUPABASE_DB_URL_DEV:-}" ]]; then
            echo "::error::Missing secret SUPABASE_DB_URL_DEV"
            exit 1
          fi
          if [[ -z "${SUPABASE_DB_URL_PROD:-}" ]]; then
            echo "::error::Missing secret SUPABASE_DB_URL_PROD"
            exit 1
          fi

      - name: Snapshot public schema from DEV
        run: |
          set -euo pipefail
          psql "$SUPABASE_DB_URL_DEV" -v ON_ERROR_STOP=1 -X -qAt -f scripts/public_schema_snapshot.sql > dev_public_schema.txt

      - name: Snapshot public schema from PROD
        run: |
          set -euo pipefail
          psql "$SUPABASE_DB_URL_PROD" -v ON_ERROR_STOP=1 -X -qAt -f scripts/public_schema_snapshot.sql > prod_public_schema.txt

      - name: Snapshot storage schema from DEV
        run: |
          set -euo pipefail
          psql "$SUPABASE_DB_URL_DEV" -v ON_ERROR_STOP=1 -X -qAt -f scripts/storage_snapshot.sql > dev_storage_snapshot.txt

      - name: Snapshot storage schema from PROD
        run: |
          set -euo pipefail
          psql "$SUPABASE_DB_URL_PROD" -v ON_ERROR_STOP=1 -X -qAt -f scripts/storage_snapshot.sql > prod_storage_snapshot.txt

      - name: Snapshot applied migrations (DEV)
        run: |
          set -euo pipefail
          psql "$SUPABASE_DB_URL_DEV" -v ON_ERROR_STOP=1 -X -qAt -c "select version from supabase_migrations.schema_migrations order by version;" > dev_migrations.txt

      - name: Snapshot applied migrations (PROD)
        run: |
          set -euo pipefail
          psql "$SUPABASE_DB_URL_PROD" -v ON_ERROR_STOP=1 -X -qAt -c "select version from supabase_migrations.schema_migrations order by version;" > prod_migrations.txt

      - name: Diff DEV vs PROD (public)
        id: diff
        run: |
          set -euo pipefail
          diff -u dev_public_schema.txt prod_public_schema.txt > dev_vs_prod_public_schema.diff || true
          diff -u dev_storage_snapshot.txt prod_storage_snapshot.txt > dev_vs_prod_storage_snapshot.diff || true
          diff -u dev_migrations.txt prod_migrations.txt > dev_vs_prod_migrations.diff || true

          has_diff=false
          if [[ -s dev_vs_prod_public_schema.diff ]]; then
            echo "::error::DEV e PROD estão com drift no schema public (veja o artifact dev_vs_prod_public_schema.diff)."
            echo "Diff public lines: $(wc -l < dev_vs_prod_public_schema.diff)" >> "$GITHUB_STEP_SUMMARY"
            has_diff=true
          fi

          if [[ -s dev_vs_prod_storage_snapshot.diff ]]; then
            echo "::error::DEV e PROD estão com drift no Storage (buckets/policies) (veja o artifact dev_vs_prod_storage_snapshot.diff)."
            echo "Diff storage lines: $(wc -l < dev_vs_prod_storage_snapshot.diff)" >> "$GITHUB_STEP_SUMMARY"
            has_diff=true
          fi

          if [[ -s dev_vs_prod_migrations.diff ]]; then
            echo "::error::DEV e PROD estão com drift no histórico de migrations (supabase_migrations.schema_migrations) (veja o artifact dev_vs_prod_migrations.diff)."
            echo "Diff migrations lines: $(wc -l < dev_vs_prod_migrations.diff)" >> "$GITHUB_STEP_SUMMARY"
            has_diff=true
          fi

          echo "has_diff=$has_diff" >> "$GITHUB_OUTPUT"
          if [[ "$has_diff" == "false" ]]; then
            echo "DEV e PROD estão alinhados (public + storage + migrations)." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload schema snapshots + diff (debug)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dev_prod_public_schema
          path: |
            dev_public_schema.txt
            prod_public_schema.txt
            dev_vs_prod_public_schema.diff
            dev_storage_snapshot.txt
            prod_storage_snapshot.txt
            dev_vs_prod_storage_snapshot.diff
            dev_migrations.txt
            prod_migrations.txt
            dev_vs_prod_migrations.diff
          retention-days: 7

      - name: Alert (Issue) if drift detected
        if: steps.diff.outputs.has_diff == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const label = 'drift';
            const runUrl = `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`;
            const title = `Drift detectado: DEV vs PROD (${new Date().toISOString().slice(0, 10)})`;
            const body = [
              'Detectamos divergência entre DEV e PROD (schema public / storage / migrations).',
              '',
              `Run: ${runUrl}`,
              '',
              'Próximo passo:',
              '- Baixar o artifact `dev_prod_public_schema` e transformar os diffs em migrations.',
              '- Aplicar via PR dev→main (checks verdes) e revalidar.',
            ].join('\n');

            // Garante label (sem falhar se já existir)
            try {
              await github.rest.issues.getLabel({ owner, repo, name: label });
            } catch {
              await github.rest.issues.createLabel({ owner, repo, name: label, color: 'd73a4a', description: 'Divergência DEV vs PROD (drift)' });
            }

            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: label,
              per_page: 20,
            });

            const existing = issues.find((i) => i.title.startsWith('Drift detectado: DEV vs PROD'));
            if (existing) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: existing.number,
                body: `Novo drift detectado.\n\n${runUrl}`,
              });
              core.notice(`Comentado no issue existente #${existing.number}`);
            } else {
              const created = await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
                labels: [label],
              });
              core.notice(`Issue criado: ${created.data.html_url}`);
            }

      - name: Fail if drift detected
        if: steps.diff.outputs.has_diff == 'true'
        run: |
          exit 1
